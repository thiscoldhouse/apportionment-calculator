<html>
  <head>
    <meta charset="utf-8">
    <link href="https://thiscold.house/lib/fontawesome.css" rel="stylesheet">
    <script src="https://thiscold.house/lib/jquery-3.3.1.js"></script>
    <link rel="stylesheet" type="text/css" href="https://thiscold.house/main.css">
    <title>Congressional Apportionment Calculator
    </title>
  </head>
  <body>
    <style>
      /* results table */
      .main-table {
          margin-left: auto;
          margin-right: auto;
          border-collapse: collapse;
          width: 90%;
          font-family: sans-serif;
          overflow-x: scroll;
      }
      .main-table thead tr {
          background-color: #333333;
          color: #ffffff;
          text-align: left;
      }
      .main-table th,
      .main-table td {
          padding: 12px 15px;
      }
      .main-table tbody tr {
          border-bottom: 1px solid #dddddd;
      }

      .main-table tbody tr:nth-of-type(even) {
          background-color: #f3f3f3;
      }

      .main-table tbody tr.active-row {
          font-weight: bold;
          color: #009879;
      }

      .popDataEdit:hover {
          cursor: pointer;
      }

      .reset-buttons button {
          background-color: #333333;
          border: 1px solid n;
          color: white;
          padding: 10px 20px;
          cursor: pointer;
          float: left;
      }

      #add-row{
          float: right;
      }
      #undo{
          float: right;
      }

      /* buttons */
      .reset-buttons button:not(:last-child) {
          border-right: none;
      }

      .reset-buttons{

          white-space:normal;
          width: 90%;
          content: "";
          display: block;
          margin: auto;
          float: left;
          margin-left: 5%;
      }

      .reset-buttons button:hover {
          background-color: #222222;
      }

      .edit-icon {
          display: inline-block;
      }
      .edit-icon:hover {
          cursor: pointer;
      }


    </style>
    <br>
    <div class="blog-entry">

      <a href="https://interstitial.coop" target="_blank" style="text-decoration:none; color: black;">
        <div style="align: left; text-align:center; font-size:10;">
          <img src="/interstitial.png" width="30px"/>
          <span style="display:block; padding-top:3px;">An Interstitial Project</span>
        </div>
      </a>

      <h2 style="text-align: center">Calculating Congressional Apportionment</h2>
      <p>This is a simple implementation of <a target="_blank" href="https://en.wikipedia.org/wiki/United_States_congressional_apportionment#The_method_of_equal_proportions">the algorithm used for congressional apportionment</a>. </p>
      <p>If you want something a little more digestible than the wiki page, the fantastic podcast <a target="_blank" href="https://openargs.com">Opening Arguments</a> did an <a target="_blank" href="https://openargs.com/oa486-apportionment-might-not-be-final/">episode</a> on apportionment, which inspired me to make this widget.</p>
      <p>So have some fun, play around with changing the populations, or add new states. The code is open source and can be viewed on <a target="_blank" href="https://github.com/thiscoldhouse/apportionment-calculator">my github.</a> For feedback and bug reports, <a href="mailto:ale@interstitial.coop">email me</a>.</p>
      <p><span style="color:red">Correction: </span>A previous version of this page used the census's <i>resident</i> population instead of the <i>apportionment</i> population. From <a target="_blank" href="https://www.census.gov/topics/public-sector/congressional-apportionment/about/faqs.html">the census's FAQ:</a></p>
      <p><i>"The apportionment population count for each of the 50 states includes the state’s total resident population plus a count of the overseas federal employees (and their dependents living with them overseas) who have that state listed as their home state in their employers’ administrative records."
      </i></p>
    </div>
    <br>

    <div class="reset-buttons">
      <button id="2020-reset">Reset table to 2020 census results</button>
      <button id="2010-reset">Reset table to 2010 census results</button>
      <button id="undo" style="display:none">Undo</button>
      <button id="add-row">Add state</button>


    </div>

    <br>
    <table class="main-table">
      <thead>
        <tr>
          <th>2020 Rank</th>
          <th>State</th>
          <th>Population (editable)</th>
          <th>Apportionment</th>
          <th>Change From Last Edit</th>
          <th>Change From 2020 Census</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="table-body">
      </tbody>
    </table>
    <br><br>

    <script>
      $(document).ready(function(){

        // ---------- data ------------ //
        // pulled from wikipedia
        var census = [{
	  "Rank": 1,
	  "State": "California",
	  "2010 Population": "37,341,989",
	  "2020 Population": "39,576,757"
        }, {
	  "Rank": 2,
	  "State": "Texas",
	  "2010 Population": "25,268,418",
	  "2020 Population": "29,183,290"
        }, {
	  "Rank": 3,
	  "State": "Florida",
	  "2010 Population": "18,900,773",
	  "2020 Population": "21,570,527"
        }, {
	  "Rank": 4,
	  "State": "New York",
	  "2010 Population": "19,421,055",
	  "2020 Population": "20,215,751"
        }, {
	  "Rank": 5,
	  "State": "Pennsylvania",
	  "2010 Population": "12,734,905",
	  "2020 Population": "13,011,844"
        }, {
	  "Rank": 6,
	  "State": "Illinois",
	  "2010 Population": "12,864,380",
	  "2020 Population": "12,822,739"
        }, {
	  "Rank": 7,
	  "State": "Ohio",
	  "2010 Population": "11,568,495",
	  "2020 Population": "11,808,848"
        }, {
	  "Rank": 8,
	  "State": "Georgia",
	  "2010 Population": "9,727,566",
	  "2020 Population": "10,725,274"
        }, {
	  "Rank": 9,
	  "State": "North Carolina",
	  "2010 Population": "9,565,781",
	  "2020 Population": "10,453,948"
        }, {
	  "Rank": 10,
	  "State": "Michigan",
	  "2010 Population": "9,911,626",
	  "2020 Population": "10,084,442"
        }, {
	  "Rank": 11,
	  "State": "New Jersey",
	  "2010 Population": "8,807,501",
	  "2020 Population": "9,294,493"
        }, {
	  "Rank": 12,
	  "State": "Virginia",
	  "2010 Population": "8,037,736",
	  "2020 Population": "8,654,542"
        }, {
	  "Rank": 13,
	  "State": "Washington",
	  "2010 Population": "6,753,369",
	  "2020 Population": "7,715,946"
        }, {
	  "Rank": 14,
	  "State": "Arizona",
	  "2010 Population": "6,412,700",
	  "2020 Population": "7,158,923"
        }, {
	  "Rank": 15,
	  "State": "Massachusetts",
	  "2010 Population": "6,559,644",
	  "2020 Population": "7,033,469"
        }, {
	  "Rank": 16,
	  "State": "Tennessee",
	  "2010 Population": "6,375,431",
	  "2020 Population": "6,916,897"
        }, {
	  "Rank": 17,
	  "State": "Indiana",
	  "2010 Population": "6,501,582",
	  "2020 Population": "6,790,280"
        }, {
	  "Rank": 18,
	  "State": "Maryland",
	  "2010 Population": "5,789,929",
	  "2020 Population": "6,185,278"
        }, {
	  "Rank": 19,
	  "State": "Missouri",
	  "2010 Population": "6,011,478",
	  "2020 Population": "6,160,281"
        }, {
	  "Rank": 20,
	  "State": "Wisconsin",
	  "2010 Population": "5,698,230",
	  "2020 Population": "5,897,473"
        }, {
	  "Rank": 21,
	  "State": "Colorado",
	  "2010 Population": "5,044,930",
	  "2020 Population": "5,782,171"
        }, {
	  "Rank": 22,
	  "State": "Minnesota",
	  "2010 Population": "5,314,879",
	  "2020 Population": "5,709,752"
        }, {
	  "Rank": 23,
	  "State": "South Carolina",
	  "2010 Population": "4,645,975",
	  "2020 Population": "5,124,712"
        }, {
	  "Rank": 24,
	  "State": "Alabama",
	  "2010 Population": "4,802,982",
	  "2020 Population": "5,030,053"
        }, {
	  "Rank": 25,
	  "State": "Louisiana",
	  "2010 Population": "4,553,962",
	  "2020 Population": "4,661,468"
        }, {
	  "Rank": 26,
	  "State": "Kentucky",
	  "2010 Population": "4,350,606",
	  "2020 Population": "4,509,342"
        }, {
	  "Rank": 27,
	  "State": "Oregon",
	  "2010 Population": "3,848,606",
	  "2020 Population": "4,241,500"
        }, {
	  "Rank": 28,
	  "State": "Oklahoma",
	  "2010 Population": "3,764,882",
	  "2020 Population": "3,963,516"
        }, {
	  "Rank": 29,
	  "State": "Connecticut",
	  "2010 Population": "3,581,628",
	  "2020 Population": "3,608,298"
        }, {
	  "Rank": 30,
	  "State": "Utah",
	  "2010 Population": "2,770,765",
	  "2020 Population": "3,275,252"
        }, {
	  "Rank": 31,
	  "State": "Iowa",
	  "2010 Population": "3,053,787",
	  "2020 Population": "3,192,406"
        }, {
	  "Rank": 32,
	  "State": "Nevada",
	  "2010 Population": "2,709,432",
	  "2020 Population": "3,108,462"
        }, {
	  "Rank": 33,
	  "State": "Arkansas",
	  "2010 Population": "2,926,229",
	  "2020 Population": "3,013,756"
        }, {
	  "Rank": 34,
	  "State": "Mississippi",
	  "2010 Population": "2,978,240",
	  "2020 Population": "2,963,914"
        }, {
	  "Rank": 35,
	  "State": "Kansas",
	  "2010 Population": "2,863,813",
	  "2020 Population": "2,940,865"
        }, {
	  "Rank": 36,
	  "State": "New Mexico",
	  "2010 Population": "2,067,273",
	  "2020 Population": "2,120,220"
        }, {
	  "Rank": 37,
	  "State": "Nebraska",
	  "2010 Population": "1,831,825",
	  "2020 Population": "1,963,333"
        }, {
	  "Rank": 38,
	  "State": "Idaho",
	  "2010 Population": "1,573,499",
	  "2020 Population": "1,841,377"
        }, {
	  "Rank": 39,
	  "State": "West Virginia",
	  "2010 Population": "1,859,815",
	  "2020 Population": "1,795,045"
        }, {
	  "Rank": 40,
	  "State": "Hawaii",
	  "2010 Population": "1,366,862",
	  "2020 Population": "1,460,137"
        }, {
	  "Rank": 41,
	  "State": "New Hampshire",
	  "2010 Population": "1,321,445",
	  "2020 Population": "1,379,089"
        }, {
	  "Rank": 42,
	  "State": "Maine",
	  "2010 Population": "1,333,074",
	  "2020 Population": "1,363,582"
        }, {
	  "Rank": 43,
	  "State": "Rhode Island",
	  "2010 Population": "1,055,247",
	  "2020 Population": "1,098,163"
        }, {
	  "Rank": 44,
	  "State": "Montana",
	  "2010 Population": "994,416",
	  "2020 Population": "1,085,407"
        }, {
	  "Rank": 45,
	  "State": "Delaware",
	  "2010 Population": "900,877",
	  "2020 Population": "990,837"
        }, {
	  "Rank": 46,
	  "State": "South Dakota",
	  "2010 Population": "819,761",
	  "2020 Population": "887,770"
        }, {
	  "Rank": 47,
	  "State": "North Dakota",
	  "2010 Population": "675,905",
	  "2020 Population": "779,702"
        }, {
	  "Rank": 48,
	  "State": "Alaska",
	  "2010 Population": "721,523",
	  "2020 Population": "736,081"
        }, {
	  "Rank": 49,
	  "State": "Vermont",
	  "2010 Population": "630,337",
	  "2020 Population": "643,503"
        }, {
	  "Rank": 50,
	  "State": "Wyoming",
	  "2010 Population": "568,300",
	  "2020 Population": "577,719"
        }]

        // ---- end data ---- //

        var state = {
          'pops': {},
          'previousApportionment': {},
          'apportionment2020': {},
          'apportionment': {}
        };


        // -------- util --------- //
        function copyObject(obj){
          return $.extend({}, obj);
        }

        function commaSeparateNumber(val){
          // taken from  https://stackoverflow.com/questions/3883342/add-commas-to-a-number-in-jquery
          while (/(\d+)(\d{3})/.test(val.toString())){
            val = val.toString().replace(/(\d+)(\d{3})/, '$1'+','+'$2');
          }
          return val;
        }

        function cleanNumber(number){
          if (typeof(number) == "number"){
            return number
          }
          number = number.replace(/\,/g,'')
          number = parseInt(number)
          return number;
        };

        function fillPopsInState(censusKey){
          var statePops = {};
          for(i in census){
            statePops[census[i]['State']] = cleanNumber(census[i][censusKey]);
          }
          updateState('pops', statePops);
        };

        // ------ rendering stuff-------- //-
        function makeTableRow(rank, state, population, apportionment, change, changeSince2020){
          var changeColor = 'black';
          if (change > 0){
            changeColor = 'green'
          }
          else if (change < 0){
            changeColor = 'red'
          }
          change = '<span style="color:' + changeColor + '">' + change + '</span>';

          changeColor = 'black';
          if (changeSince2020 > 0){
            changeColor = 'green'
          }
          else if (changeSince2020 < 0){
            changeColor = 'red'
          }
          changeSince2020 = '<span style="color:' + changeColor + '">' + changeSince2020 + '</span>';
          return $(
            '<tr id="' + state + '-row"><td>' + rank +
              '</td><td>' + state +
              "</td><td id='" + state + "-pop' class='popDataEdit' contenteditable='true'>" +
              commaSeparateNumber(population) +
              "</td><td>" + apportionment +
              "</td><td>" + change +
              "</td><td>" + changeSince2020 +
              "</td><td>" +
              "<div class='edit-icon' id='edit-" + state + "pop'>&#x270F;&nbsp&nbsp;&nbsp&nbsp;&nbsp&nbsp</div>" +
              "<div class='edit-icon' id='delete-" + state + "'>&#x1F5D1;</div>" +
              "</td></tr>"
          )
        };

        function render(){
          $('#table-body').empty();

          // this should probably be moved to not be calculated everytime
          censusDict = {};
          for (i in census){
            censusDict[census[i]['State']] = census[i];
          }

          var sortedStates = Object.keys(state.pops);
          sortedStates.sort(
            function(state1, state2){
              return state.pops[state1] < state.pops[state2] && 1 || -1;
            });

          for (i in sortedStates){
            let stateName = sortedStates[i];
            var rank = 'N/A';
            if (stateName in censusDict){
              rank = censusDict[stateName]['Rank'];
            }
            change = 'N/A';
            if (!$.isEmptyObject(state.previousApportionment)){
              let previous = state.previousApportionment[stateName] || 0;
              let current = state.apportionment[stateName];
              change = current - previous;
            }
            let current = state.apportionment[stateName];
            let previous = state.apportionment2020[stateName] || 0;
            let changeSince2020 = current - previous;

            $('#table-body').append(
              makeTableRow(rank, stateName, state.pops[stateName], state.apportionment[stateName], change, changeSince2020)
            )
          }
        };

        // ------ event handlers ----- //
        function attachTableHandlers(){
          $('.edit-icon').on('click', function(e){
            if ($(e.currentTarget).attr('id').includes('edit')){
              console.log('here');
              $(e.currentTarget).parent().siblings('.popDataEdit').trigger('focus');
            }
            else if ($(e.currentTarget).attr('id').includes('delete')){
              let stateName = $(e.currentTarget).attr('id').split('-')[1];
              statePops = copyObject(state.pops);
              delete statePops[stateName];
              updateState('pops', statePops);
              update();
            }
            else {
              console.log('Something has gone wrong');
            }
          });

          $('.popDataEdit').on('keydown', function(e){
            if (e.key === 'Enter' || e.keyCode === 13) {
              e.preventDefault();
              $(e.currentTarget).blur();
            }
          });

          $('.popDataEdit').on('blur', function(e){
            var newPop = e.currentTarget.innerHTML;
            let doc = new DOMParser().parseFromString(newPop, 'text/html');
            newPop = doc.body.textContent || 0;
            newPop = cleanNumber(newPop);
            if(!newPop){
              newPop = 0
            }
            let oldPop = state.pops[$(e.currentTarget).siblings()[1].innerHTML];
            if (cleanNumber(oldPop) == cleanNumber(newPop)){
              return;
            }
            $(e.currentTarget).html(newPop);
            let statePops = copyObject(state.pops);
            statePops[$(e.currentTarget).siblings()[1].innerHTML] = newPop;
            updateState('pops', statePops);
            update();
          });
        }

        function attachButtonHandlers(){
          $('#2020-reset').on('click', function(){
            fillPopsInState('2020 Population');
            update();
          });

          $('#2010-reset').on('click', function(){
            fillPopsInState('2010 Population');
            update();
          });

          $('#undo').on('click', function(){
            state.pops = copyObject(state.previouspops);
            state.previouspops = null;
            update();
          });

          $('#add-row').on('click', function(){
            stateName = prompt('Enter state name');
            if (!stateName){
              alert("Can't enter an empty state name");
              return;
            }
            stateName = stateName.charAt(0).toUpperCase() + stateName.slice(1);
            if (stateName in state.pops){
              alert("Please enter a unique state name");
              return;
            }

            newPop = prompt('Enter population for ' + stateName);
            let doc = new DOMParser().parseFromString(newPop, 'text/html');
            newPop = doc.body.textContent || 0;
            newPop = cleanNumber(newPop);
            let statePops = copyObject(state.pops);
            statePops[stateName] = newPop;
            updateState('pops', statePops);
            update();
          });

        }

        // ------ actual math --------- //
        function updateResult(result, pops, i){
          var priority = {};
          var winningState = null;
          var winningScore = 0

          for (stateName in result){
            let population = cleanNumber(pops[stateName]);
            priority[stateName] = population / Math.sqrt(result[stateName] * (result[stateName] + 1))
            if (priority[stateName] > winningScore){
              winningState = stateName
              winningScore = priority[stateName]
            }

          }
          result[winningState] += 1
          return result
        }

        function calculateApportionment(){
          // first round, some initial setup
          var result = {}
          for (stateName in state.pops){
            result[stateName] = 1
          }
          let leftoverSeats = 435 - Object.keys(state.pops).length;
          console.log(leftoverSeats);
          for (i=0; i<leftoverSeats; i++){
            result = updateResult(result, state.pops, i)
          }
          state.previousApportionment = copyObject(state.apportionment);
          state.apportionment = result;
          return result
        }

        // ------ main page controller and helpers -- //
        function addUndoIfAppropriate(){
          if (state.previouspops) {
            $('#undo').css('display', 'block');
          }
          else {
            $('#undo').css('display', 'none');
          }
        }

        function updateState(k, v){
          state['previous' + k] = copyObject(state[k]);
          state[k] = v;
        }

        function update(){
          calculateApportionment();
          render();
          attachTableHandlers();
          addUndoIfAppropriate();
        }

        // ------ initial render -------- //

        // initial data
        fillPopsInState('2020 Population');
        calculateApportionment();
        let apportionment2020 = state.apportionment;
        state.apportionment2020 = apportionment2020;
        state.previouspops = undefined;  // no undo button at first

        // initial render
        render();
        attachButtonHandlers();
        attachTableHandlers();
      });
      </script>
  </body>
</html>
